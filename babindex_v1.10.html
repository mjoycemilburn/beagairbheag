<!DOCTYPE html>
<html lang="en-GB">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description"
        content="BeagAirBheag study toolkit: Player, Transcript viewer, Dictionary Links, Note faciities" />
    <meta name="keywords" content="beagairbheag" />

    <!-- indexedDb promises-version from https://github.com/jakearchibald/idb-->
    <script src="https://unpkg.com/idb@5/build/iife/index-min.js"></script>

    <title>BeagAirBheag Companion</title>

    <link rel="shortcut icon" href="https://ngatesystems.com/beagairbheag/bab.png">

    <style>
        .fugitivebutton {
            height: 4vw;
            width: 4vw;
            margin: 2vw 1vw 2vw 1vw;
        }

        .audiobutton {
            height: 4vw;
            width: 4vw;
            border: none;
            background-size: 50% 50%;
            background-color: white;
            background-repeat: no-repeat;
            background-position: center;
            outline: none;
        }

        .notemark {
            max-height: 3vh;
            background: white 0.0;
        }

        .splashscreen {
            max-width: 100%;
            max-height: 100%;
            margin-left: auto;
            margin-right: auto;
            display: block;
            cursor: pointer;
        }

        .babbutton {
            padding: .25rem;
            font: larger;
            background-color: aquamarine;
            border: 1px solid black;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>

</head>

<body>

    <!--HTML5 audio-->
    <audio id="music" type="audio/mpeg">
    </audio>

    <div style="display: flex; flex-direction: column;">

        <!--############  Page header - Fugitive buttons and Player Controls  ############# -->

        <div id="pageheader" style="display: flex;height: 100%;justify-content: space-between; text-align: center;">

            <!--    The controls are displayed centred between balancing banks of "fugitive" buttons. The idea is to avoid 
                    cluttering the page- the buttons are only displayed when the mouse moves over them. -->

            <div id='buttondiv1' style="opacity:1;" onmouseover="displayButtonDiv('buttondiv1');"
                onmouseout="fadeButtonDiv('buttondiv1');">
                <img class="fugitivebutton" src="https://ngatesystems.com/beagairbheag/img/txtsearch.svg"
                    title="Click to Search BaB texts and Notes" onclick="setActivityPanelToElement('textsearchpanel');">
                <img class="fugitivebutton" src="https://ngatesystems.com/beagairbheag/img/jtrlaunch.svg"
                    title="Click to open your Jotter" onclick="displayJotter();">
                <img class="fugitivebutton" src="https://ngatesystems.com/beagairbheag/img/ggllaunch.svg"
                    title="Click to open the Google Translator"
                    onclick="event.stopPropagation(); displayPopupWindow('https://translate.google.com/?sl=gd&tl=enL');">
            </div>

            <div style="height:4vw; margin: 2vw;  border-style: solid;border-width: thin;">
                <div style="display: inline-flex; justify-content: center;  align-items: center;">
                    <div>
                        <button id="pbutton" class="audiobutton"
                            style="background-image: url('https://ngatesystems.com/beagairbheag/img/play.png');"
                            onclick="toggleAudio();" ; title="Start or stop the audio-player" type="button"></button>
                        <button class="audiobutton"
                            style="background-image: url('https://ngatesystems.com/beagairbheag/img/rplay.png');"
                            onclick="rewindAudio();"
                            title="D&egrave; thuirt e? - Rewind the audio-player 5 seconds and restart (alternatively use scroll wheel over playhead)"
                            type="button"></button>
                        <button class="audiobutton"
                            style="background-image: url('https://ngatesystems.com/beagairbheag/img/shriek.png');"
                            title="Create a note"
                            onclick="pauseAudio(); postTime=Math.floor(music.currentTime); setActivityPanelToElement('insertnotepanel'); document.getElementById('cnotetext').focus();"
                            type="button"></button>
                    </div>
                    <div style="padding: 0 2vw 0 1vw;">
                        <span id="currtime">00:00:00</span>/
                        <span id="finishtime"></span>
                    </div>
                </div>
            </div>

            <div id='buttondiv2' style="opacity:1;" onmouseover="displayButtonDiv('buttondiv2');"
                onmouseout="fadeButtonDiv('buttondiv2');">
                <img class="fugitivebutton" src="https://ngatesystems.com/beagairbheag/img/backup.svg?"
                    title="Copy your jotter and notes to local storage" onclick="backupDataStores();">
                <img class="fugitivebutton" src="https://ngatesystems.com/beagairbheag/img/restore.svg?"
                    title="Restore your jotter and notes from local backup filesf"
                    onclick="event.stopPropagation(); uploadBackupFile();">
                <img class="fugitivebutton" src="https://ngatesystems.com/beagairbheag/img/mark.svg?"
                    title="Click for Colin Mark Translations Workshops"
                    onclick="event.stopPropagation(); displayColinMarkWindow(event);">
            </div>
        </div>

        <!-- ############  Audio Header - Note line, Play line and Text line ############# -->

        <div id="audioheader" style="
                    width: 95%; 
                    padding-left: .25vw;
                    padding-right: .25vw; 
                    margin: auto; 
                    margin-bottom: 4vh;
                    border: solid;">

            <!-- Display an empty noteline - we'll fill this in dynamically later-->
            <div id="noteline" style="height: 3vh; margin-top: .5vh; background: whitesmoke;"
                title="Marks on this line indicate the position of notes on the audio">
                <a id="nsample" style="position:absolute; margin-left: 0px;">
                    <img class="notemark" src="https://ngatesystems.com/beagairbheag/img/notemarkblack.svg"></a>
                <div id="notes"></div>
            </div>

            <!-- Now the soundbar  - ditto, but with the playhead already seeded within it -->

            <div id="playline" style="
                    width: 100%;
                    background: rgba(0,0,0,.3);
                    margin-top: .5vh;
                    margin-bottom: .5vh;
                    border-radius: 999px;">
                <!-- forces radius to be half the height-->
                <div id="playhead" style="
                        cursor: pointer;
                        width: 4vh;
                        height: 4vh;
                        border-radius: 50%;
                        background: black;"></div>
            </div>

            <!-- And finally Text bar.  -->

            <div id="textline" style="height:4vh; margin-top: 1vh; margin-bottom: 1vh;">
            </div>
        </div>

        <!-- ############  Panel Header - Logo panel, Activity panel and Episode panel ############# -->

        <!-- flex-grow is used here to allow the children divs of the panel header to occupy
                     the remaining space on the page without defining height exlicitly -->

        <div id="panelheader" style="
                    display:flex; 
                    flex-grow: 1; 
                    flex-shrink: 1; 
                    flex-basis: auto;">

            <!-- First of all, the "Beag air Bheag" Logo panel, the leftmost of the three display panels-->

            <div id="logopanel" style="
                    width: 25%; 
                    margin: 3vw;
                    overflow: auto;">

                <div id="logoandbuttons">
                    <img id="logo" style="max-width:100%;" src="https://ngatesystems.com/beagairbheag/img/logo.png"
                        alt="Beag Air Bheag Companion logo">
                    <p></p>
                    <div style="margin-top: 1vh; margin-left: 1vw;">
                        <button class="babbutton" onclick="setActivityPanelToString(about);" type="button"
                            title="About the Companion">About
                        </button>
                        <button class="babbutton" onclick="setActivityPanelToString(hints);" type="button"
                            title="Click for Hints">Hints

                    </div>
                </div>
            </div>

            <!-- Now the multi-function activity panel-->

            <div id="activitypanel" style="
                    width: 50%;
                    flex-grow: 1; 
                    flex-shrink: 1; 
                    flex-basis: auto; 
                    margin-left: 3vw;
                    margin-right: 3vw;
                    padding: 1vw;
                    border: solid black;
                    overflow-y: auto;
                    height: 53vh;">
            </div>

            <!-- And finally, the "Episode" panel  the rightmost of the three display panels-->

            <div id="episodepanel" style="
                    width: 25%; 
                    margin-right: 3vw; 
                    overflow: auto;">

                <p><strong>
                        Now Playing : Series <span id="seriesnum"></span> : <span id="episodenam"></strong>
                </p>
                <p>First broadcast : <span id="firstondate"></span></p>
                <p>Learner of the Week : <span id="learneroftheweek"></span></p>
                <p><strong>Want a different programme? </strong></p>
                <p>Series <span id="seriespicklistcontainer"></span> : <span id="episodepicklistcontainer"></span></p>
                <br>
                <p>Current dictionary :&nbsp;&nbsp;<button id="dictionarypref" class="babbutton"
                        title="Toggle text look-up dictionary" onclick="toggleDictionaryPref()"></button></p>
                <p id="currentsplashscreen">Current splash-screen:<br>
                    <i id='splashscreentitle' style="margin-left:1vw; display: block;"></i></p>

            </div>
        </div>
    </div>

    <!-- hidden jotterdiv panel displayed as fixed-size "popup"  -->

    <div id="jotterdiv" style="
                display: none; width: 80%; height: 80%;
                position: absolute; margin-left: auto; margin-right: auto; left: 0; right: 0; top: 5%; 
                padding: 3vh 2vw 2vh 2vw; border: 1px solid black; 
                background: white;
                z-index: 10;" onclick="event.stopPropagation();">
        <form enctype="multipart/form-data" method="post" name="jotterform" style="width: 100%; height:90%;">
            <input type="text" name="action" hidden value="U">

            <textarea id="userjotter" name="user_jotter"
                style="width:100%; height: 100%; font-size: larger; background:paleturquoise;"
                onkeydown="keyPresedOnJotter(event);" spellcheck="false"></textarea>
        </form>

        <p><button id="jottersavebutton" class="babbutton" type="button" onclick="saveJotter();">Save</button>
            <span id="savemessage" style="margin-left: 3vw;"></span>
        </p>
    </div>

    <!-- hidden zoomdiv panel displayed as fixed-size "popup"  -->

    <div id="zoomdiv" style="
                        display: none; width: 80%; height: 80%;
                        position: absolute; margin-left: auto; margin-right: auto; left: 0; right: 0; top: 5%; 
                        padding: 1vh 2vw 1vh 2vw; border: 1px solid black; 
                        background: white;
                        text-align: center;
                        z-index: 10;" onclick="event.stopPropagation();">
        <img id="zoomedimage" style="height: 100%;">
    </div>

    <!-- hidden text for the 'insertnotepanel' -->

    <span id='insertnotepanel' style="display: none;">
        <div style="
                display: flex;
                width: 60%;
                margin: 5% auto;
                border-style: solid;
                border-width: thin;
                padding: 1.5%;
                justify-content: space-around;">
            <div><button id="lBiteButton" title="Start the sound-bite one second ealier" onclick="playBiteNudgedLeft();"
                    type="button">Nudge L</button></div>
            <div><button id="pBiteButton" title="Play a five-second sound-bite centred on the current time"
                    onclick="postTime=Math.floor(music.currentTime); playBite();" type="button">Play</button></div>
            <div><button id="rBiteButton" title="Start the sound-bite one second later" onclick="playBiteNudgedRight();"
                    type="button">Nudge R</button></div>
        </div>

        <p style="text-align: center">Note/Query text</p>
        <textarea id="cnotetext" rows="4" cols="50" style="margin: 5px auto; display: block;" name="cnotetext"
            title="Notes on sound - eg 'jay hoorshht e' = dè thuirt e : what did he say?"></textarea>

        <div style="
                display: flex;
                width: 60%;
                margin: 5% auto;
                border-style: solid;
                border-width: thin;
                padding: 1.5%;
                justify-content: space-around;">
            <div><button class="babbutton" onclick="insertNote('note')" type="button">Save as Note</button></div>
            <div><button class="babbutton" onclick="insertNote('query')" type="button">Save as Query</button></div>
            <div><button class="babbutton" onclick="setActivityPanelToString('');" type="button">Cancel</button></div>
        </div><br>
    </span>

    <!-- hidden text for the 'editnotepanel' -->

    <span id='editnotepanel' style='display: none;'>
        <div style='margin: 20px auto; text-align: center;'>
            <button id='enBiteButton' class="babbutton" type='button'
                title="Replay the five-second sound-bite centred on this note" onclick="playBiteInEditPanel();">Play
                Again</button>
        </div>
        <textarea id='enotetext' rows='4' cols='50' name='ecnotetext' style='margin: 5px auto; display: block;'
            onkeydown="document.getElementById('saveeditednotebutton').style.background = 'pink';">
        </textarea>
        <div style='
                    display: flex;
                    border-style: solid;
                    border-width: thin;
                    margin:  5% auto;
                    width: 15%;
                    padding: 1.5%;
                    justify-content: center;'>
            <button id="saveeditednotebutton" class="babbutton" title='Save edited Note' type='button'>Save</button>
        </div>
        <div style='
                    display: flex;
                    width: 60%;
                    margin: 5% auto;
                    border-style: solid;
                    border-width: thin;
                    padding: 1.5%;
                    justify-content: space-around;'>

            <button id='changetoquerybutton' class="babbutton" style='display: none;'
                title='Change note type to "Query"' type='button'>
                Re-save as Query</button>
            <button id='changetonotebutton' class="babbutton" style='display: none;' title='Change note type to "Note"'
                type='button'>
                Re-save as Note</button>
            <button id='deletenotebutton' class="babbutton" title='Delete Note' type='button'>Delete</button>
            <button type='button' class="babbutton" onclick='setActivityPanelToString("");'>Cancel</button>
        </div>
    </span>

    <!-- hidden text for the 'textsearchpanel' -->

    <div id="textsearchpanel" style="display: none; width: 25vw; padding: 2vw">
        <p> <label>Search for:</label>&nbsp;&nbsp;
            <input id="searchstring" type="text" name="search_words" title="Search string" autofocus size="24"
                onKeyPress="trackSearchStringEntry(event)"></p>
        <p> <button id="searchbutton" class="babbutton" type="button" onclick="searchTextsAndNotes()">Launch
                Search</button>&nbsp;&nbsp;&nbsp;</p>
    </div>

    <!-- utilities - empty form for the XMLHTTP PHP calls, "spinner for text loads and empty anchor for backup downloads -->

    <form id='dummyform'>
    </form>

    <div id="waiticon" style="position: fixed; z-index: 10; display: none">Loading...
    </div>

    <a id="backupdownloadlink" download></a>

    <script>

        var currentSystemVersionNumber = "1.10";
        var latestSystemVersionNumber;
        var cryptography; // text for cryptography, about and hints will be served from central sources
        var about;
        var hints;

        // The Companion uses numerous centrally-served .svg, .png, .php and .html elements. But changing the server
        // copy won't necessarily mean that a Cmopanion user will see the changes because the browser
        // will continue to use cached local copies until these become "stale" - which 
        // may take a few weeks. For php elements, the problem is side-stepped by "pre-staling" the code using
        // headers. For html elements, we fool the browser by adding a date-time "GET" parameter (they're called
        // so rarely that the associated inefficientcy is insignificant). The numerous graphic elements are a
        // different story, however. On balance it seems best to leave alone - nothing is going to change that
        // would prejudice operation of the Companion.

        ///// Screen Management Scripts //////////

        // Does local storage contains 'last programme used' details? -  (use localStorage.removeItem("lastSeriesNum")
        // to clear whn testing)

        if (localStorage.getItem('lastSeriesNum') === null) {

            // no it doesn't - so initialise them as Series 12 Episode 1 

            localStorage.setItem('lastSeriesNum', '12');
            localStorage.setItem('lastEpisodeNam', 'Episode 1');
            localStorage.setItem('lastEpisodeFinishTime', '5421');
            localStorage.setItem('lastFirstOnDate', '2020/06/14');
            localStorage.setItem('lastLearnerOfTheWeek', 'Kevin Leetion');
            localStorage.setItem('lastBBCProgrammeUrl', 'https://www.bbc.co.uk/programmes/m000k423');
            localStorage.setItem('lastDictionaryPref', 'BBC');
            localStorage.setItem('lastSplashScreenFilename', 'red_book.png');
            localStorage.setItem('lastSplashScreenTitle', '"Leabhar Dearg Chlann Mhuirich - courtey Scottish Nat Coll');
            localStorage.setItem('lastBBCDownloadFilename', 'BeagAirBheag-20200614-Episode1');
        }

        // OK can now initialise "current" user and programme variables from
        // stable local storage values with known initial settings

        var currentSeriesNum = localStorage.getItem('lastSeriesNum');
        var currentEpisodeNam = localStorage.getItem('lastEpisodeNam');
        var currentEpisodeFinishTime = localStorage.getItem('lastEpisodeFinishTime'); // mmss
        var currentFirstOnDate = localStorage.getItem('lastFirstOnDate'); // formatted date (JS date-formatting is rubbish)
        var currentLearnerOfTheWeek = localStorage.getItem('lastLearnerOfTheWeek');
        var currentBBCProgrammeUrl = localStorage.getItem('lastBBCProgrammeUrl');
        var currentDictionaryPref = localStorage.getItem('lastDictionaryPref');
        var currentSplashScreenFilename = localStorage.getItem('lastSplashScreenFilename');
        var currentSplashScreenTitle = localStorage.getItem('lastSplashScreenTitle');
        var currentBBCDownloadFilename = localStorage.getItem('lastBBCDownloadFilename');

        var playWidth;
        var headWidth;
        var noteWidth;

        var duration;

        var textTypesData; // global array of text-type data

        // define startupSplashScreen - you get this only when you use BaB for  the very first time

        var startupSplashScreenContent = " \
        <p style='text-align: center;'> \
            <strong>Gàidhlig and Cryptography</strong><br><br> \
            The entertaining and thought-provoking novels of Neal Stephenson make frequent reference to the isles of \
            Qwhglm (pronounced 'Taghum', with stress on the second syllable), mythically located off the west coast \
            of Scotland. The inhabitants, naturally, speak Qwghlmian, an impenetrable language employing just 16 \
            consonant and no vowels. Qwghlmian is thus ideally suited to cryptographic applications. Hmm. Very funny, \
            I'm sure. \
        </p>";
        var startupSplashScreenTitle = "Qwghlmian";

        var activitypanel = document.getElementById("activitypanel");

        window.onload = function () {

            // launch a few low-priority asynch operations in parallel

            getLatestSystemVersionNumber(); // won't need this until user clicks 'about'
            initialiseTextTypeData(); // won't need this until we display the texts line

            // make sure we've got an indexedDB database with all the necessary datastores

            initialiseIndexedDBStores();

            // fade the fugitive buttons by triggering a transition
            fadeButtonDiv('buttondiv1');
            fadeButtonDiv('buttondiv2');

            // get the picklists and build the screen

            buildProgrammePicklists(currentSeriesNum, currentEpisodeNam)

        }

        async function getLatestSystemVersionNumber() {

            // get latest system version number - low priority asynch operation 

            var fData = new FormData(document.getElementById("dummyform"));
            fData.append("helper_type", "get_system_data");

            try {
                const response = await get("https://ngatesystems.com/beagairbheag/php/player_helpers_v1.10.php", fData)

                if (response.indexOf("%failed%") != -1) {
                    alert(response);
                } else {

                    const JSONObject = JSON.parse(response);

                    latestSystemVersionNumber = JSONObject.versionnumber;
                    cryptography = JSONObject.cryptography;
                    about = JSONObject.about;
                    hints = JSONObject.hints;

                    var aboutHeader = "<p style = 'text-align: center; color:blue;''>\
                        You are currently using version v" + currentSystemVersionNumber + " of the Companion.";

                    if (latestSystemVersionNumber > currentSystemVersionNumber) {
                        var dateObject = new Date();
                        var currentTime = dateObject.getTime();
                        aboutHeader += "The latest version is v" + latestSystemVersionNumber + ". Click \
                            <a href = 'https://ngatesystems.com/beagairbheag/index.html?ver=" + currentTime + "' >here</a> if you would like to upgrade";
                    } else {
                        aboutHeader += "This is the latest version of the Companion.";
                    }

                    about = aboutHeader + "</p>" + about;
                }
            }
            catch (err) {
                alert("Failed! " + err);
                return;
            }
        }

        async function initialiseTextTypeData() {
            // launch initialisation of textTypesData (header info) - another low priority asynch operation

            var fData = new FormData(document.getElementById("dummyform"));
            fData.append("helper_type", "get_text_types_data");

            try {
                const response = await get("https://ngatesystems.com/beagairbheag/php/player_helpers_v1.10.php", fData)

                if (response.indexOf("%failed%") != -1) {
                    alert(response);
                } else {

                    textTypesData = JSON.parse(response);
                }
            }
            catch (err) {
                alert("Failed! " + err);
                return;
            }
        }

        async function initialiseIndexedDBStores() {
            const db = await idb.openDB('BaB', 1, {
                // the following code is only activated if the database
                // has never been opened before
                upgrade(db) {

                    // Create a "notes" store for noteObjects
                    const notesStore = db.createObjectStore('notes', {
                        // The 'textkey' property of the textObject will be the key.
                        keyPath: 'notekey',
                    });
                    // Create an index on the 'notekey' property of noteObjects.
                    notesStore.createIndex('notes_by_key_path', 'notekey');
                    // Create a secondary non-unique index on the 'noteprogrammekey' property of noteObjects.
                    notesStore.createIndex('notes_by_programme_path', 'noteprogrammekey', { unique: false });

                    // Create a "texts" store for textObjects
                    const textsStore = db.createObjectStore('texts', {
                        // The 'textkey' property of the textObject will be the key.
                        keyPath: 'textkey',
                    });
                    // Create an index on the 'textkey' property of the textObjects.
                    textsStore.createIndex('texts_by_key_path', 'textkey');

                    // Create a "jotter" store forthe jotterObject
                    const jotterStore = db.createObjectStore('jotter', {
                        // The 'jotterkey' property of the jotterObject will be the key.
                        keyPath: 'jotterkey',
                    });
                    // Create an index on the 'jotterkey' property of the jotterObjects.
                    jotterStore.createIndex('jotter_by_key_path', 'jotterkey');

                },
            });

            // put an initial empty jotter record into the jotter store for key
            // 'user' if this doesn't already exist 

            {
                const tx = db.transaction('jotter', 'readwrite');
                var jotterObject = { 'jotterkey': 'user', 'text': '' };
                try {
                    await Promise.all([
                        tx.store.add(jotterObject), // only a single store in play, so "store" references this automatically
                        tx.done,
                    ]);
                } catch (e) {
                    const recordAlreadyExists = 'Key already exists in the object store.';
                    if (e.toString().indexOf(recordAlreadyExists) != -1) {
                        return;
                    } else {
                        alert("Failed! " + e);
                        return;
                    }
                }
            }
        }

        async function buildProgrammePicklists(seriesNum, episodeNam) {

            var fData = new FormData(document.getElementById("dummyform"));
            fData.append("helper_type", "build_programme_picklists");
            fData.append("series_num", seriesNum);
            fData.append("episode_nam", episodeNam);

            try {
                const response = await get("https://ngatesystems.com/beagairbheag/php/player_helpers_v1.10.php", fData)

                if (response.indexOf("%failed%") != -1) {
                    alert(response);
                } else {

                    const JSONObject = JSON.parse(response);
                    seriesPicklist = JSONObject.seriespicklist;
                    episodePicklist = JSONObject.episodepicklist;

                    document.getElementById('seriespicklistcontainer').innerHTML = seriesPicklist;
                    document.getElementById('episodepicklistcontainer').innerHTML = episodePicklist;

                    buildScreenForCurrentEpisode();

                    if (currentSeriesNum != '') music.src = currentBBCDownloadFilename + ".mp3";
                    music.currentTime = 0;
                }
            }
            catch (err) {
                alert("Failed! " + err);
            }
        }

        var audioExceptionMessageJustDisplayed = false;
        var scaleFactor;
        var scaleCorrectionForNote;

        function buildScreenForCurrentEpisode() {

            // display the splashscreen for this instance of the Companion

            // choose a splashscreen (use localStorage.removeItem('firstuseofbab'); to test

            if (localStorage.getItem('firstuseofbab') === null) {
                setActivityPanelToString(startupSplashScreenContent);
                document.getElementById('splashscreentitle').innerHTML = startupSplashScreenTitle;
                document.getElementById('currentsplashscreen').style.display = "block";
                localStorage.setItem('firstuseofbab', 1);
            } else {
                setActivityPanelToString('<img class="splashscreen" onclick="zoomSplashScreen(); event.stopPropagation();" src="https://ngatesystems.com/beagairbheag/splashscreens/' + currentSplashScreenFilename + '">');
                document.getElementById('splashscreentitle').innerHTML = currentSplashScreenTitle;
                document.getElementById('currentsplashscreen').style.display = "block";
            }

            duration = timeToSeconds(currentEpisodeFinishTime);

            document.getElementById('finishtime').innerHTML = formatTime(duration);
            document.getElementById('seriesnum').innerHTML = currentSeriesNum;
            document.getElementById('episodenam').innerHTML = currentEpisodeNam;
            document.getElementById('firstondate').innerHTML = currentFirstOnDate;
            document.getElementById('learneroftheweek').innerHTML = currentLearnerOfTheWeek;
            document.getElementById("dictionarypref").textContent = currentDictionaryPref;

            // get the pixel widths of the playline and playhead - these are key parameter
            // used throughout the rest of the layout, determining the absolute position of
            // notes, playhead and texts in the audioheader
            // Also use the sample note mark to get the scaled width of the notemark image - 
            // this is used to position the centre of the mark precisely

            playWidth = document.getElementById('playline').getBoundingClientRect().width; // floating point number
            headWidth = document.getElementById('playhead').getBoundingClientRect().width;
            noteWidth = document.getElementById('nsample').getBoundingClientRect().width;

            // We calculate the left margin of a note img at time t seconds as :
            // (0.5 * headWidth) + (t * (playWidth- headWidth) / duration) - (0.5* noteWidth)
            // or t*scaleFactor + scaleCorrectionForNote

            scaleFactor = (playWidth - headWidth) / duration;
            scaleCorrectionForNote = (0.5 * headWidth) - (0.5 * noteWidth); // note this is a floating point number

            buildNoteline(currentSeriesNum, currentEpisodeNam, scaleFactor, scaleCorrectionForNote);

            // We calculate the left margin of a text img at time t seconds as :
            // (0.5 * headWidth) + (t * (playWidth - headWidth) / duration)
            // or t*scaleFactor + scaleCorrectionForText
            // We calculate the length of a text as rightMargin - leftMargin

            var scaleCorrectionForText = (0.5 * headWidth);

            buildTextsline(currentSeriesNum, currentEpisodeNam, scaleFactor, scaleCorrectionForText);

            // add an event listener for the 'music' audio tag. The "true" value in the third
            // parameter means the event is captured in the capturing phase

            music.addEventListener('error', function (e) {
                var noSourcesLoaded = (this.networkState === HTMLMediaElement.NETWORK_NO_SOURCE);
                if (noSourcesLoaded) {
                    var alertMessage = "\
                    <div style = 'text-align: center;'>\
                        Oops - can't find your download file at : <br><br>\
                        <div style = 'color: red; overflow-y: auto;'>" + music.src + "</div>\
                        <br><br>You need to download this podcast from its BBC download page at :\
                        <div style = 'margin-top: 2vh; margin-bottom: 2vh; text-align: center;'>\
                            <button class = 'babbutton' onclick = 'window.open(\"" + currentBBCProgrammeUrl + "\", \"_blank\");'>BBC Episode Download Page</button>" + "\
                        </div>\
                        and wait for the file to appear fully in your download folder. If you are\
                        running the Companion from the download folder you should now be able to launch the\
                        episode by simply clicking the 'Play' button. Otherwise you will first need to\
                        move the downloaded file manually to the new babindex location.\
                    </div>";
                    setActivityPanelToString(alertMessage);
                    audioExceptionMessageJustDisplayed = true;
                }
            }, true);

        }

        function toggleDictionaryPref() {

            if (currentDictionaryPref == "BBC") {
                currentDictionaryPref = "AFB";
            } else {
                currentDictionaryPref = "BBC";
            }
            document.getElementById("dictionarypref").textContent = currentDictionaryPref;

            //set local storage

            localStorage.setItem('lastDictionaryPref', currentDictionaryPref);
        }

        var noteLeftMargins = [];
        async function buildNoteline(seriesNum, episodeNam, scaleFactor, scaleCorrectionForNote) {

            // clear away any existing NoteLine content

            document.getElementById('notes').innerHTML = "";

            const db = await idb.openDB('BaB', 1);
            const tx = db.transaction('notes', 'readwrite');

            // Get the contents of "notes", for series seriesNum and episode episodeNam
            var noteProgrammeKey = currentSeriesNum + "%" + currentEpisodeNam;
            const noteObjects = await db.getAllFromIndex('notes', 'notes_by_programme_path', noteProgrammeKey);

            var noteLine = '';

            if (noteObjects != undefined) {

                for (var i = 0; i < noteObjects.length; i++) {

                    var noteKey = noteObjects[i].notekey;
                    var noteKeyElements = noteKey.split("%");
                    var secondsIntoProgramme = noteKeyElements[2];

                    var noteText = noteObjects[i].notetext;
                    var noteType = noteObjects[i].notetype;

                    var marginLeft = Math.round((secondsIntoProgramme * scaleFactor) + scaleCorrectionForNote);
                    var noteTextStub = noteText;
                    if (noteText.length > 15) noteTextStub = noteText.substring(0, 15) + ' ...';

                    noteLine += "\
                    <a id='n" + secondsIntoProgramme + "'\
                        style='position:absolute; margin-left: " + marginLeft + "px; cursor: pointer; width: 5px; text-align: center;' \
                        title='" + noteTextStub + "'\
                        onclick = 'displayEditNotePanel(\"n" + secondsIntoProgramme + "\");'>";

                    if (noteType === "note") {
                        noteLine += "<img class='notemark' src='https://ngatesystems.com/beagairbheag/img/notemarkblack.svg'></a>";
                    } else {
                        noteLine += "<img class='notemark' src='https://ngatesystems.com/beagairbheag/img/notemarkred.svg'></a>";
                    }

                    // create an entry in the noteLeftMargins array - we use this later to prevent the user from
                    // creating notes that are so close together they obscure each other

                    noteLeftMargins.push(marginLeft);

                }
                document.getElementById('notes').innerHTML = noteLine;
                noteLeftMargins.sort(function (a, b) { return a - b }); // sort the left margins in ascending numerial order
            }
        }

        async function buildTextsline(seriesNum, episodeNam, scaleFactor, scaleCorrectionForText) {

            var fData = new FormData(document.getElementById("dummyform"));
            fData.append("helper_type", "build_textline");
            fData.append("series_num", seriesNum);
            fData.append("episode_nam", episodeNam);
            fData.append("scale_factor", scaleFactor);
            fData.append("scale_correction_for_text", scaleCorrectionForText);

            try {
                const response = await get("https://ngatesystems.com/beagairbheag/php/player_helpers_v1.10.php", fData)

                if (response.indexOf("%failed%") != -1) {
                    alert(response);
                } else {
                    document.getElementById('textline').innerHTML = response;
                }
            }
            catch (err) {
                alert("Failed! " + err);
            }

        }

        async function insertNote(noteType) {

            // insert a note of the given type for the current series and episode into the notes datastore

            var postTimeAsInteger = Math.round(postTime);
            var newnote = document.getElementById("n" + postTimeAsInteger);
            var marginLeft = (0.5 * headWidth) + (postTimeAsInteger * (playWidth - headWidth) / duration) - (0.5 * noteWidth);

            if (newNoteTooCloseToExisting(marginLeft)) {
                alert('Oops - this note is too close to an existing note');
                return;
            }

            var noteText = document.getElementById('cnotetext').value;

            // noteKey is constructed from the following four components: 
            // **  seriesNum, episodeNam, secondsIntoProgramme separated by % symbols **
            // thus, for, eg 4%Episde 3%1805

            var noteKey = currentSeriesNum + "%" + currentEpisodeNam + "%" + postTimeAsInteger;
            var noteProgrammeKey = currentSeriesNum + "%" + currentEpisodeNam;

            var noteObject = { 'notekey': noteKey, 'noteprogrammekey': noteProgrammeKey, 'notetext': noteText, 'notetype': noteType };

            // Add the note in a transaction so we can check everything works
            const db = await idb.openDB('BaB', 1);
            {
                const tx = db.transaction('notes', 'readwrite');

                try {
                    await Promise.all([
                        tx.store.put(noteObject), // only a single store in play, so "store" references this automatically
                    ]);
                } catch (e) {
                    alert(e);
                    return;
                }
            }

            // add the note to the noteline - rather tedious as you have to build "the new child
            // first as an empty <a> element, declare its innerhtml and then add its properties

            if (noteType === "note") {
                var noteInnerHTML = "<img class='notemark' src='https://ngatesystems.com/beagairbheag/img/notemarkblack.svg'></a>";
            } else {
                var noteInnerHTML = "<img class='notemark' src='https://ngatesystems.com/beagairbheag/img/notemarkred.svg'></a>";
            }

            var newNote = document.createElement("a");  // create a new <a> element
            newNote.innerHTML = noteInnerHTML; // add some html to it

            // now add properties to the <a> element as well

            newNote.setAttribute("id", "n" + postTimeAsInteger);
            newNote.setAttribute("title", noteText.substring(0, 15));

            newNote.setAttribute("style", "position: absolute; margin-left: " + marginLeft + "px");

            var onclickLink = "displayEditNotePanel('n" + postTimeAsInteger + "')";
            newNote.setAttribute("onclick", onclickLink);

            // and finally, add the new <a> element into the DOM as a child of the 'notes' div

            document.getElementById('notes').appendChild(newNote);

            // display an "OK" message in activitypanel

            if (noteType === "note") {
                var noteDisplayType = "Note";
            } else {
                var noteDisplayType = "Query";
            }

            var message = "<p style='margin-top:3vh; text-align: center; color: blue'><span>" + noteDisplayType + " saved</span></p>";
            setActivityPanelToString(message);

            // add the new note to the noteLeftMargins array and re-sort it

            noteLeftMargins.push(marginLeft);
            noteLeftMargins.sort(function (a, b) { return a - b });

        }

        function newNoteTooCloseToExisting(leftMargin) {
            // checks that a propsed neew note will not be so close to an existing note that
            // their notemarks will obscure one another - they need to be at least 1.25* noteWidth apart

            var lastLeftMarginBefore = -1;
            var firstLeftMarginAfter = -1;

            for (var i = 0; i < noteLeftMargins.length; i++) {
                var j = noteLeftMargins.length - i;

                if (noteLeftMargins[i] < leftMargin) lastLeftMarginBefore = noteLeftMargins[i];
                if (noteLeftMargins[j] > leftMargin) firstLeftMarginAfter = noteLeftMargins[j];

            }

            if (lastLeftMarginBefore == -1 && firstLeftMarginAfter == -1) return false;
            if (lastLeftMarginBefore == -1 && (firstLeftMarginAfter - leftMargin) > .5 * noteWidth) return false;
            if (firstLeftMarginAfter == -1 && (leftMargin - lastLeftMarginBefore) > .5 * noteWidth) return false;
            if (((firstLeftMarginAfter - leftMargin) > 1.25) && ((leftMargin - lastLeftMarginBefore) > .5 * noteWidth)) return false;

            return true;

        }

        async function displayEditNotePanel(noteId) {

            var secondsIntoProgramme = parseInt(noteId.substring(1));
            postTime = secondsIntoProgramme;
            playBiteInEditPanel();

            // retrieve the note from notestore

            const db = await idb.openDB('BaB', 1);

            var noteKey = currentSeriesNum + "%" + currentEpisodeNam + "%" + secondsIntoProgramme;
            const noteObject = await db.get('notes', noteKey);

            setActivityPanelToElement('editnotepanel');

            document.getElementById('enotetext').value = noteObject.notetext;
            document.getElementById('enotetext').focus();

            document.getElementById('saveeditednotebutton').onclick = function () { editNote(noteId, noteObject.notetype) };

            if (noteObject.notetype === "note") {
                document.getElementById('changetoquerybutton').style.display = 'block';
                document.getElementById('changetoquerybutton').onclick = function () { editNote(noteId, "query") };
                document.getElementById('deletenotebutton').onclick = function () { deleteNote(noteId, "note") };
            } else {
                document.getElementById('changetonotebutton').style.display = 'block';
                document.getElementById('changetonotebutton').onclick = function () { editNote(noteId, "note") };
                document.getElementById('deletenotebutton').onclick = function () { deleteNote(noteId, "query") };

            }
        }

        async function editNote(noteId, noteType) {

            document.getElementById('saveeditednotebutton').style.background = 'initial';

            // replace the text and type of the note at noteId for the current 
            // series and episode in the notes datastore

            var noteText = document.getElementById('enotetext').value;
            var secondsIntoProgramme = parseInt(noteId.substring(1));;

            var noteKey = currentSeriesNum + "%" + currentEpisodeNam + "%" + secondsIntoProgramme;
            var noteProgrammeKey = currentSeriesNum + "%" + currentEpisodeNam;
            var noteObject = { 'notekey': noteKey, 'noteprogrammekey': noteProgrammeKey, 'notetext': noteText, 'notetype': noteType };

            // Add the note in a transaction so we can check everything works
            const db = await idb.openDB('BaB', 1);
            {
                const tx = db.transaction('notes', 'readwrite');

                try {
                    await Promise.all([
                        tx.store.put(noteObject), // only a single store in play, so "store" references this automatically
                    ]);
                } catch (e) {
                    alert(e);
                    return;
                }
            }

            // set the note icon note_type in case it has changed

            if (noteType === "note") {
                document.getElementById(noteId).innerHTML = "<img class='notemark' src='https://ngatesystems.com/beagairbheag/img/notemarkblack.svg'>";
                document.getElementById('saveeditednotebutton').onclick = function () { editNote(noteId, "note") };
                document.getElementById('changetoquerybutton').style.display = 'block';
                document.getElementById('changetonotebutton').style.display = 'none';
                document.getElementById('changetoquerybutton').onclick = function () { editNote(noteId, "query") };
            } else {
                document.getElementById(noteId).innerHTML = "<img class='notemark' src='https://ngatesystems.com/beagairbheag/img/notemarkred.svg'>";
                document.getElementById('saveeditednotebutton').onclick = function () { editNote(noteId, "query") };
                document.getElementById('changetonotebutton').style.display = 'block';
                document.getElementById('changetoquerybutton').style.display = 'none';
                document.getElementById('changetonotebutton').onclick = function () { editNote(noteId, "note") };
            }

            // ditto the title

            var noteTextStub = document.getElementById('enotetext').value;
            if (noteText.length > 15) noteTextStub = noteText.substring(0, 15) + ' ...';
            document.getElementById(noteId).title = noteTextStub;

            document.getElementById('deletenotebutton').onclick = function () { deleteNote(noteId) };

        }

        async function deleteNote(noteId, noteType) {

            var secondsIntoProgramme = parseInt(noteId.substring(1));
            var noteKey = currentSeriesNum + "%" + currentEpisodeNam + "%" + secondsIntoProgramme;

            // Delete the note in a transaction so we can check everything works
            const db = await idb.openDB('BaB', 1);
            {
                const tx = db.transaction('notes', 'readwrite');

                try {
                    await Promise.all([
                        tx.store.delete(noteKey), // only a single store in play, so "store" references this automatically
                    ]);
                } catch (e) {
                    alert(e);
                    return;
                }
            }

            var noteElement = document.getElementById("n" + secondsIntoProgramme);
            noteElement.remove();

            // remove it from the noteLeftMargins array too

            var noteLeftMargin = noteElement.style.marginLeft;
            for (var i = 0; i < noteLeftMargins.length; i++) {

                if (noteLeftMargins[i] + "px" === noteLeftMargin) {
                    noteLeftMargins.splice(i, 1);
                    i--;
                }
            }

            // display an "OK" message in activitypanel

            if (noteType === "note") {
                var noteDisplayType = "Note";
            } else {
                var noteDisplayType = "Query";
            }

            var message = "<p style='margin-top:3vh; text-align: center; color: blue'><span>" + noteDisplayType + " removed</span></p>";
            setActivityPanelToString(message);

        }

        var transcriptSource;
        async function displayTextSource(textKey, textUrl, textHeader, searchString) {

            // display the text for textSource, first retrieving this, if necessary, from the BBC page
            // for the text-type. Where the display request has come from the search panel, highlight
            // the searchWord occurrences in the text

            // textKey is constructed from the following four components: 
            // **  seriesNum, episodeNam, textType, textTitle separated by % symbols **
            // thus, for, eg 4%Episde 3%tarscriobh$Pàirc Hampden

            var textKeyElements = textKey.split("%");
            var seriesNum = textKeyElements[0];
            var episodeNam = textKeyElements[1];
            var textType = textKeyElements[2];
            var textTitle = textKeyElements[3];

            var textDataForTextType = textTypesData.filter(function (e) {
                return (e.texttype == textType)
            });

            var textHeading = textHeader + " : " + textTitle;

            const db = await idb.openDB('BaB', 1);

            // try to retrieve the text for the given key
            {

                transcriptSource = await db.get('texts', textKey);
            }

            if (transcriptSource == undefined) {

                showWaitIcon();

                var fData = new FormData(document.getElementById("dummyform"));
                fData.append("helper_type", "get_transcript_source");
                fData.append("url", textUrl);

                try {
                    const response = await get("https://ngatesystems.com/beagairbheag/php/player_helpers_v1.10.php", fData)

                    if (response.indexOf("%failed%") != -1) {
                        alert(response);
                    } else {

                        // extracting the text with javascript turned out to be no slower than using php
                        // and generally faster - hard to see why

                        transcriptSource = autoEditText(response);
                        hideWaitIcon();

                        setActivityPanelToString("<strong>" + textHeading + "</strong>" + transcriptSource);
                        activitypanel.ondblclick = amFaclairBeagSearch; // add double click to drive the dictionary lookup

                        // tuck a copy away in the local Texts indexedDB database for use by "search" button

                        textObject = { 'textkey': textKey, "text": transcriptSource };
                        saveTextInLocalDb(textObject);
                    }
                }
                catch (err) {
                    alert("Failed! " + err);
                    return;
                }

            } else {

                // if searchString is defined, highlight occurrences in retrievedText. This is slightly tedious as we're
                // doing case-insensitive matches and therefore have to do case-insensitive searches in retrievedText
                // to find the bits to be highlighted. See https://stackoverflow.com/questions/52175779/how-can-i-perform-a-case-insensitive-replace-in-javascript
                // for the source of the following trick

                if (searchString != '') {
                    var searchRegex = new RegExp(searchString, "gi");
                    var highlightedText = transcriptSource.text.replace(searchRegex, '<b style ="color: red;">$&</b>');
                } else {
                    var highlightedText = transcriptSource.text;
                }

                setActivityPanelToString("<strong>" + textHeading + "</strong>" + highlightedText);
                activitypanel.ondblclick = amFaclairBeagSearch; // add double click to drive the dictionary lookup

            }
        }

        function autoEditText(localInput) {

            var localInputLength;
            var paraStart;
            var paraEnd;
            var output = '';

            outOfParas = false;
            input = '';

            while (!outOfParas) {

                localInputLength = localInput.length;
                // get position of first <p>
                paraStart = localInput.indexOf("<p>");

                if (paraStart == -1) {

                    outOfParas = true;

                } else {

                    // ignore text before this point
                    localInput = localInput.substring(paraStart, localInputLength);
                    localInputLength = localInput.length;
                    // get position of companion  </p>
                    paraEnd = localInput.indexOf("</p>");
                    // tuck away everything up to this point
                    output = output + localInput.substring(0, paraEnd + 4);
                    // ignore text before this point
                    localInput = localInput.substring(paraEnd + 4, localInputLength);

                }
                // change any ʼ characters to ' - they cause 503 errors on the POST!
                output = output.replace(/ʼ/g, "'");
                output = output.replace(/‘/g, "'");

            }

            // accented letters in the BBC texts are coded as html entities - eg è will be coded
            // as &egrave; We're using ISO codes in searches and notes, so we need to replace these

            output = output.replace(/&agrave;/g, "à");
            output = output.replace(/&egrave;/g, "è");
            output = output.replace(/&igrave;/g, "ì");
            output = output.replace(/&ograve;/g, "ò");
            output = output.replace(/&ugrave;/g, "ù");
            output = output.replace(/&igrave;/g, "ì");

            return output;

        }

        async function saveTextInLocalDb(textObject) {
            const db = await idb.openDB('BaB', 1);

            // Add the text in a transaction so we can check if it's already there
            {
                const tx = db.transaction('texts', 'readwrite');

                try {
                    await Promise.all([
                        tx.store.add(textObject), // only a single store in play, so "store" references this automaically
                        tx.done,
                    ]);
                } catch (e) {
                    const textAlreadyExists = 'Key already exists in the object store.';
                    if (e.toString().indexOf(textAlreadyExists) != -1) {
                        return;
                    } else {
                        alert(e);
                        return;
                    }
                }
            }
        }

        function amFaclairBeagSearch() {

            // The following ternary (see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Conditional_Operator)
            // Finds the "value" of the selected word as:

            selectedWord = (typeof (window["getSelection"]) == "undefined" ? document.getSelection() : window.getSelection().toString());
            displayAFBSearchResults(selectedWord);
        }

        function displayAFBSearchResults(searchWord) {

            if (searchWord) {
                if (currentDictionaryPref === "AFB") {
                    var DictionaryWindow = window.open("https://www.faclair.com/index.aspx?txtSearch=" + searchWord, "AFB", "width=500, height=600, resizable=1, menubar=no, scrollbars=1, status=1, titlebar=1, toolbar=no, location=no, personalbar=1");
                } else {
                    var DictionaryWindow = window.open("https://learngaelic.scot/dictionary/index.jsp?abairt=" + searchWord + "&slang=gd&wholeword=false", "BBC", "width=500, height=600, resizable=1, menubar=no, scrollbars=1, status=1, titlebar=1, toolbar=no, location=no, personalbar=1");
                }
                DictionaryWindow.focus();
            }
        }

        function changeSeries() {
            // Series Number has been changed, redraw the picklists with the
            // episodes for the new series and set Episode number to undefined

            var seriespicklist = document.getElementById('seriespicklist');
            currentSeriesNum = seriespicklist.options[seriespicklist.selectedIndex].value;

            pauseAudio();

            buildProgrammePicklists(currentSeriesNum, 'undefined');
        }

        function changeEpisode() {
            // Episode Number has changed, redraw the picklists with the
            // new episode and try to change the current audio

            var episodepicklist = document.getElementById('episodepicklist');
            currentEpisodeNam = episodepicklist.options[episodepicklist.selectedIndex].value;
            buildScreenForChangedEpisode();

        }

        async function buildScreenForChangedEpisode() {

            // get the download filename and duration etc for the currently-selected programme

            var fData = new FormData(document.getElementById("dummyform"));
            fData.append("helper_type", "get_programme_data");
            fData.append("series_num", currentSeriesNum);
            fData.append("episode_nam", currentEpisodeNam);

            try {
                const response = await get("https://ngatesystems.com/beagairbheag/php/player_helpers_v1.10.php", fData)

                if (response.indexOf("%failed%") != -1) {
                    alert(response);
                } else {

                    JSONObject = JSON.parse(response);
                    currentEpisodeFinishTime = JSONObject.currentEpisodeFinishTime;
                    currentFirstOnDate = JSONObject.currentFirstOnDate;
                    currentLearnerOfTheWeek = JSONObject.currentLearnerOfTheWeek;
                    currentBBCProgrammeUrl = JSONObject.currentBBCProgrammeUrl;
                    currentSplashScreenFilename = JSONObject.currentSplashScreenFilename;
                    currentSplashScreenTitle = JSONObject.currentSplashScreenTitle;
                    currentBBCDownloadFilename = JSONObject.audiofilename;

                    localStorage.setItem('lastSeriesNum', currentSeriesNum);
                    localStorage.setItem('lastEpisodeNam', currentEpisodeNam);
                    localStorage.setItem('lastEpisodeFinishTime', currentEpisodeFinishTime);
                    localStorage.setItem('lastFirstOnDate', currentFirstOnDate);
                    localStorage.setItem('lastLearnerOfTheWeek', currentLearnerOfTheWeek);
                    localStorage.setItem('lastBBCProgrammeUrl', currentBBCProgrammeUrl);
                    localStorage.setItem('lastSplashScreenFilename', currentSplashScreenFilename);
                    localStorage.setItem('lastSplashScreenTitle', currentSplashScreenTitle);
                    localStorage.setItem('lastBBCDownloadFilename', currentBBCDownloadFilename);

                    buildScreenForCurrentEpisode();

                    if (editNotePanelDisplayRequired) {
                        displayEditNotePanel(currentNoteId);
                        editNotePanelDisplayRequired = false
                    } else {
                        music.addEventListener("timeupdate", timeUpdate);
                        music.src = JSONObject.audiofilename + ".mp3";
                        music.currentTime = 0;
                        pbutton.style.backgroundImage = "url('https://ngatesystems.com/beagairbheag/img/play.png')";
                    }
                }
            }
            catch (err) {
                alert("Failed! " + err);
                return;
            }

        }

        function displayButtonDiv(buttondivid) {
            document.getElementById(buttondivid).style.transition = 'opacity 0s';
            document.getElementById(buttondivid).style.opacity = 1;
        }

        function fadeButtonDiv(buttondivid) {
            document.getElementById(buttondivid).style.transition = 'opacity 5s';
            document.getElementById(buttondivid).style.opacity = 0;
        }

        function trackSearchStringEntry(event) {
            if (event.keyCode == 13) {
                return searchTextsAndNotes();
            } else {
                return true;
            }

        }

        async function searchTextsAndNotes() {

            // search the texts that have been visited (and therefore stored in the indexedDB texts
            // datastore) for matches with searchString. ditto notes

            var searchString = document.getElementById("searchstring").value;

            if (searchString == '') return;

            const db = await idb.openDB('BaB', 1);
            // const tx = db.transaction('texts', 'readwrite');
            // Get the contents of "texts" in textkey order:
            var texts = await db.getAllFromIndex('texts', 'texts_by_key_path');

            var results = '<a name="textssection"></a><a href = "#notessection" style = "font-weight: bold; color: blue;">Skip to Notes search results:</a><br><br>';
            //var searchRegex = new RegExp(searchString, "gi");

            for (var i = 0; i < texts.length; i++) {

                // OK, so the texts objects are now in texts[i]. First strip any html tags as these cause huge problems when we
                // display a portion of text and get the start of a tagged bit of text (eg a bold section) in the portion
                // without the closing tex (or vice versa).

                var strippedText = texts[i].text.replace(/<[\s\S]*?>/g, ''); // courtesy of https://stackoverflow.com/questions/5601903/jquery-almost-equivalent-of-phps-strip-tags

                // now decipher the textKey

                var keyElements = texts[i].textkey.split("%");
                var seriesNum = keyElements[0];
                var episodeNam = keyElements[1];
                var textType = keyElements[2];
                var textTitle = keyElements[3];

                var textDataForTextType = textTypesData.filter(function (e) {
                    return (e.texttype == textType)
                });
                var textHeader = textDataForTextType[0]['textheader'];
                var searchTextHeading = "Series " + seriesNum + " : " + episodeNam + " : " + textHeader + " : " + textTitle;

                // create upper-case versions of both strippedText and searchString so that we can do case-insensitive searches
                var ucStrippedText = strippedText.toUpperCase();
                var ucSearchString = searchString.toUpperCase();
                var resultCount = 0;

                for (var pos = ucStrippedText.indexOf(ucSearchString); pos !== -1; pos = ucStrippedText.indexOf(ucSearchString, pos + 1)) {

                    resultCount++;
                    // for every text that generates a match(whether in the title or the content) return a pair of table
                    // rows(one each for title and text - content) that display the match centred in a block of 30 characters 
                    // with html that will display the text itself if either of the rows is clicked

                    results += "<span style = 'cursor: pointer;' onclick = 'displayTextSource(\"" + texts[i].textkey + "\", \"\", \"" + textHeader + "\", \"" + searchString + "\");'>... " + searchTextHeading + " ...</span><br>"
                    var start = Math.max(0, pos - 15);
                    var finish = Math.min(strippedText.length, pos + 30);
                    var textBlock = strippedText.substring(start, finish)

                    // highlight the searchString string in the text block. This is slightly tedious as we'r doing
                    // case-insensitive matches and therefore have to do another case-insensitive search in textBlock
                    // to find the bit to be highlighted.

                    var ucTextBlock = textBlock.toUpperCase();
                    var posInTextBlock = ucTextBlock.indexOf(ucSearchString);

                    var textBlockWithHighlights = textBlock.substring(0, posInTextBlock) +
                        "<span style = 'color: red; font-weight:bold;'>" + textBlock.substring(posInTextBlock, posInTextBlock + searchString.length) + "</span>" +
                        textBlock.substring(posInTextBlock + searchString.length, textBlock.length);

                    results += "<span style = 'cursor: pointer;' onclick = 'displayTextSource(\"" + texts[i].textkey + "\", \"\", \"" + textHeader + "\", \"" + searchString + "\");'>... " + textBlockWithHighlights + " ... <br><br></span>";

                }
            }

            if (resultCount === '') {
                results = "<div style=\'text-align: center;\'>Sorry - no matches found in texts</div>";
            }

            // now search notes

            var searchRegex = new RegExp(searchString, "gi");

            results += '<a name="notessection"></a><a href = "#textssection" style = "font-weight: bold; color: blue;">Return to Texts search results:</a><br><br>';

            const noteObjects = await db.getAll('notes');

            if (noteObjects != undefined) {

                resultCount = 0;
                for (var i = 0; i < noteObjects.length; i++) {

                    var noteText = noteObjects[i].notetext;
                    var ucNoteText = noteText.toUpperCase();

                    var pos = ucNoteText.indexOf(ucSearchString);

                    if (pos != -1) {

                        resultCount++;
                        var noteKey = noteObjects[i].notekey;
                        var noteKeyElements = noteKey.split("%");

                        results += "<span>... Series" + noteKeyElements[0] + " : " + noteKeyElements[1] + " at " + formatTime(noteKeyElements[2]) + " ...</span><br>";

                        var start = Math.max(0, pos - 15);
                        var finish = Math.min(noteText.length, pos + 30);
                        var textBlock = noteText.substring(start, finish)

                        var highlightedTextBlock = textBlock.replace(searchRegex, '<b style ="color: red;">$&</b>');
                        results += "<span style = 'cursor: pointer;' onclick = 'buildScreenToDisplayNote(\"" + noteKey + "\");'> ... " + highlightedTextBlock + " ...</span><br><br>";

                    }
                }

                if (resultCount === '') {
                    results = "<div style=\'text-align: center;\'>Sorry - no matches found in texts</div>";
                }
            }
            document.getElementById('activitypanel').innerHTML = results;
        }

        var editNotePanelDisplayRequired;
        var currentNoteId;
        function buildScreenToDisplayNote(noteKey) {
            // Rebuild the screen to display the Episode specified by noteKey and
            // launch the editNotePanel for tpeicifed note

            var noteKeyElements = noteKey.split("%");
            currentSeriesNum = noteKeyElements[0];
            currentEpisodeNam = noteKeyElements[1];
            currentNoteId = "n" + noteKeyElements[2];
            editNotePanelDisplayRequired = true;

            changeEpisode();

        }

        var userJotterChanged;
        var isCtrl;
        var jottersavebutton = document.getElementById('jottersavebutton');

        async function displayJotter() {

            // retrieve the user's jotter and reveal the jotterdiv as a popup above the main display

            const db = await idb.openDB('BaB', 1);

            // get the jotter from the jotter store

            const jotterObject = await db.get('jotter', 'user');

            // reveal a popup window to display the jotter;

            document.getElementById('jotterdiv').style.display = "block";
            document.getElementById('userjotter').value = jotterObject.text;
            document.getElementById('userjotter').placeholder = jotterObject.text;
            document.getElementById('userjotter').focus();
            isCtrl = false;
            userJotterChanged = false;

            // Create a temporary window.onclick function to close the popup and null itself when
            // the use clicks outside

            window.onclick = function () {

                if (userJotterChanged) {
                    if (confirm("Jotter has unsaved changes - do you want to save them?")) {
                        saveJotter();
                    }
                }
                document.getElementById('jotterdiv').style.display = "none";
                window.onclick = null;
            };

        }

        async function saveJotter() {

            // save the user jotter

            var jotterObject = { 'jotterkey': 'user', 'text': document.getElementById('userjotter').value };

            // Add the jotter in a transaction so we can check everything works
            const db = await idb.openDB('BaB', 1);
            {
                const tx = db.transaction('jotter', 'readwrite');

                try {
                    await Promise.all([
                        tx.store.put(jotterObject), // only a single store in play, so "store" references this automatically
                    ]);
                } catch (e) {
                    alert(e);
                    return;
                }
            }

            isCtrl = false;
            userJotterChanged = false;
            jottersavebutton.style.background = "aquamarine";
        }

        function keyPresedOnJotter(e) {
            if (e.keyCode == 17) { //17 = ctrl
                isCtrl = true;
                return;
            }
            if (e.keyCode == 83 && isCtrl == true) { // 83 = s
                e.preventDefault(); // suppress the browser's 'save s file' action
                e.stopPropagation();
                saveJotter();
                userJotterChanged = false;
                isCtrl = false;
                return false;
            }
            userJotterChanged = true;
            isCtrl = false;
            jottersavebutton.style.background = "pink";

        }

        async function backupDataStores() {

            // build a "fileString" consisting of jotter + "%%%$$$" + notesJson, pass this to the php
            // backup_date_stores module in player_helpers.php so that this can save it in a uniquely-named
            // file on the server and return its name. We then use this to call download_babbackup.php to 
            // download the to the user's download folder (in a standard babbackup,txt file) by putting the
            // filenme into the href of an <a> element and dynamically clicking this. 

            // This complicated to and fro is due to the fact that the Content-Disposition: attachment header
            // doesn't work when it's called from javascript via an xmlhttp request - you just get the file 
            // content in your response variable! -
            // - see https://medium.com/@drevets/you-cant-prompt-a-file-download-with-the-content-disposition-header-using-axios-xhr-sorry-56577aa706d6

            const db = await idb.openDB('BaB', 1);

            // get the jotter from the jotter store

            const jotterObject = await db.get('jotter', 'user');
            var jotter = jotterObject.text;

            // now get all the notes

            const noteObjects = await db.getAll('notes');

            var notesArray = [];

            if (noteObjects != undefined) {

                for (var i = 0; i < noteObjects.length; i++) {

                    // code the noteObject to minimize the size of the backup file
                    // 'a' replaces 'notekey' (Series_num%Episode_nam%time)
                    // 'b' replaces 'notetext'
                    // 'c' replaces 'notetype' (q/n)
                    //
                    // 'noteprogrammekey' is dropped altogether as this can be determined from notekey

                    if (noteObjects[i].notetype === "note") {
                        noteObjects[i].notetype = "n";
                    } else {
                        noteObjects[i].notetype = "n";
                    }

                    notesArray[i] = { a: noteObjects[i].notekey, b: noteObjects[i].notetext, c: noteObjects[i].notetype };

                }
            }

            // turn this lot into a json

            var notesJson = JSON.stringify(notesArray);

            // and now build the fileString and send it off to the server

            var fData = new FormData(document.getElementById("dummyform"));
            fData.append("helper_type", "backup_data_stores");
            fData.append("file_string", jotter + "%%%$$$" + notesJson);

            try {
                const response = await get("https://ngatesystems.com/beagairbheag/php/player_helpers_v1.10.php", fData)

                if (response.indexOf("%failed%") != -1) {
                    alert(response);
                } else {

                    // response contains the unique filename generated for this backup. Edit the
                    // backupdownloadlink <a> element to request its download

                    var transitFilename = "babbackup" + response + ".txt";

                    document.getElementById('backupdownloadlink').setAttribute('href', 'https://ngatesystems.com/beagairbheag/php/download_babbackup.php?transitfilename=' + transitFilename);
                    document.getElementById('backupdownloadlink').click();
                }
            }
            catch (err) {
                alert("Failed! " + err);
                return;
            }

        }

        var restoreInProgress;
        var restoreId;
        async function uploadBackupFile() {

            // The user's jotter and note data sources are held in a local file. But we can't
            // read this - all a browser can do with a local file is upload it to a server. If
            // we do this, however, and store the file on the server we can then use an XMLHTTP 
            // request to read the file and "echo" the content back to the browser. But there are  
            // two snags. 
            // The first snag is easy to fix - because there's the lossibility that 
            // several users might be trying to do this at the same time, we have to give each
            // one a unique filename. So, before we upload the file we use the server to get
            // a unique number to guide the restore. So far so good...
            // The second problem is a bit more tricky. it's not possible to collect 
            // a filename from a /local/ execution like babindex.html and expect it to
            // be available in $_FILES when a /server-based/ PHP program goes looking for it - we
            // have to do this from a web-sourced page. We get round this by launch the file-upload
            // from a web-sourced popup that we start from babindex.html. To complete the circle
            // we give the unique file-number into the popup as a GET parameter when we lauch itt. 
            // Thus, the complete sequence is as follows:

            // first of all get the unique number

            var fData = new FormData(document.getElementById("dummyform"));
            fData.append("helper_type", "increment_restore_count");

            try {
                const response = await get("https://ngatesystems.com/beagairbheag/php/player_helpers_v1.10.php", fData)

                if (response.indexOf("%failed%") != -1) {
                    alert(response);
                } else {

                    var transitFilename = "babbackup" + response + ".txt";

                    // Now launch the popup with the unique filenumber as a GET parameter to the server-based
                    // upload_babbackup.html file. This will invite the user to select their backup filename

                    restoreInProgress = true;
                    restoreId = response;
                    displayPopupWindow("https://ngatesystems.com/beagairbheag/upload_babbackup.html?transitfilename=" + transitFilename);

                    // When the user clicks the restore button on upload_babbackup.html having first selected
                    // their backup file, upload_babbackup.html will call the upload_backup_file module in player_helpers
                    // to upload the file to the server and save it in the unique location on the server. All that;s
                    // needed now is to fire an XMLHTTP request to read the file and echo its content to babindex.html
                    // so that we can extract the jsons and rebuild the datastore. this is accomplished by inviting the
                    // user to "click outside this popup to finalize the restore" - this message is displyed when they
                    // click the restore button. Finally, clicking outside the popup fires a function that was created
                    // by babindex.html (in displayPopupWindow(url)) when the popup was opened. This calls the 
                    // restoreDataStores function in babindex.html to complete the process
                }
            }
            catch (err) {
                alert("Failed! " + err);
                return;
            }

        }

        async function restoreDataStores() {

            // use the restoreId global variable to tell player_helpers where to find
            // the unique file name allocated for this restore session. Supply this as
            // a GET parameter to maintain consistency with other elements of the 
            // procedure

            var transitFilename = "babbackup" + restoreId + ".txt";

            var fData = new FormData(document.getElementById("dummyform"));
            fData.append("helper_type", "restore_data_stores");
            fData.append("transitfilename", transitFilename);

            try {
                const response = await get("https://ngatesystems.com/beagairbheag/php/player_helpers_v1.10.php", fData)

                if (response.indexOf("%failed%") != -1) {
                    alert(response);
                } else {

                    // split the response into its jotter and notes_json elements

                    responseElements = response.split("%%%$$$");
                    var jotter = responseElements[0];
                    var notesJson = responseElements[1];

                    // open the Jotter and Notes stores, delete their content and
                    // replace them with the recovered data

                    const db = await idb.openDB('BaB', 1);

                    // overwrite any existing jotter - the key is fixed

                    {
                        const tx = db.transaction('jotter', 'readwrite');
                        var jotterObject = { 'jotterkey': 'user', 'text': jotter };

                        try {
                            await Promise.all([
                                tx.store.put(jotterObject), // only a single store in play, so "store" references this automatically
                            ]);
                        } catch (e) {
                            alert(e);
                            return;
                        }
                    }

                    // notes are a bit more tricky - need to delete all the existing notes
                    // with a "clear" and then insert the replacements from the recovered
                    // notes json. 

                    const tx = db.transaction('notes', 'readwrite');
                    notesArray = JSON.parse(notesJson);

                    await tx.store.clear()
                    for (var i = 0; i < notesArray.length; i++) {

                        // reconstitute the packed noteObject

                        var noteKeyElements = notesArray[i].a.split("%");
                        var noteProgrammeKey = noteKeyElements[0] + "%" + noteKeyElements[1];

                        if (notesArray[i].c === "n") {
                            var noteType = "note";
                        } else {
                            var noteType = "query";
                        }

                        var noteObject = { notekey: notesArray[i].a, noteprogrammekey: noteProgrammeKey, notetext: notesArray[i].b, notetype: noteType };

                        await tx.store.put(noteObject);
                    }

                    buildNoteline(currentSeriesNum, currentEpisodeNam, scaleFactor, scaleCorrectionForNote)

                    // now display an "OK" message in activitypanel and rebuild the noteline

                    var message = "<p style='margin-top:3vh; text-align: center; color: blue'><span>Restore completed successfully.</span></p>";
                    setActivityPanelToString(message);

                }
            }
            catch (err) {
                alert("Failed! " + err);
                return;
            }
        }

        function displayColinMarkWindow() {
            var dateObject = new Date();
            var currentTime = dateObject.getTime();
            var targetUrl = "https://ngatesystems.com/beagairbheag/colinmark/translationmasterclasses.html?ver=" + currentTime;
            displayPopupWindow(targetUrl);

        }

        ///// Utility script //////////

        function get(url, params) {

            // 'Promisified' version of basic POST, asynchronous XMLHTTP call courtesy of Jake Archibald
            // see - https://web.dev/promises/#whats-all-the-fuss-about

            return new Promise(function (resolve, reject) {
                // Do the usual XHR stuff
                var req = new XMLHttpRequest();
                req.open('POST', url);

                req.onload = function () {
                    // This is called even on 404 etc
                    // so check the status
                    if (req.status == 200) {
                        // Resolve the promise with the response text
                        resolve(req.response);
                    }
                    else {
                        // Otherwise reject with the status text
                        // which will hopefully be a meaningful error
                        reject(Error(req.statusText));
                    }
                };

                // Handle network errors
                req.onerror = function () {
                    reject(Error("Network Error"));
                };

                // Make the request
                req.send(params);
            });
        }

        function displayPopupWindow(url) {

            // popup is displayed as a centered panel of .75 display width/height

            var popupWidth = 0.75 * (window.innerWidth);
            var popupHeight = 0.75 * (window.innerHeight);
            var popupLeft = 0.5 * (window.innerWidth - popupWidth);
            var popupTop = 0.5 * (window.innerHeight - popupHeight);

            var popupSpecs = "width=" + popupWidth + ", height=" + popupHeight + ", left=" + popupLeft + ", top=" + popupTop + "t, resizable = yes, scrollbars = yes ";

            var popUpWindow = window.open(url, "popUpWindow", popupSpecs);

            // Create a temporary window.onclick function to close the popup and null itself when
            // the use clicks outside

            window.onclick = function () {
                popUpWindow.close();

                if (restoreInProgress) {
                    restoreInProgress = false;
                    restoreDataStores();
                }

                window.onclick = null;
            };
        }

        function setActivityPanelToElement(newPanelId) {
            var activitypanel = document.getElementById("activitypanel");
            var newpanelid = document.getElementById(newPanelId);
            activitypanel.innerHTML = newpanelid.innerHTML;
            document.getElementById('currentsplashscreen').style.display = "none";
        }

        function setActivityPanelToString(htmlString) {
            document.getElementById("activitypanel").innerHTML = htmlString;
            document.getElementById('currentsplashscreen').style.display = "none";
        }

        // show wait icon in the middle of the activity panel

        var activitypanel = document.getElementById('activitypanel');
        var activityPanelRect = activitypanel.getBoundingClientRect();

        var xWaitIconPosition = activityPanelRect.left + activitypanel.offsetWidth / 2;
        var yWaitIconPosition = activityPanelRect.top + activitypanel.offsetHeight / 2;

        var waiticon = document.getElementById('waiticon');

        function showWaitIcon() {
            setActivityPanelToString('');
            waiticon.style.left = xWaitIconPosition - 8 + "px";
            waiticon.style.top = yWaitIconPosition - 8 + "px";
            waiticon.style.display = "block";
        }

        function hideWaitIcon() {
            waiticon.style.display = "none";
        }

        function zoomSplashScreen() {
            // re-display the current splashscreen in the popupwindow as
            // long as it's a .png file

            if (currentSplashScreenFilename.indexOf("png") === 0) return;

            document.getElementById('zoomedimage').src = "https://ngatesystems.com/beagairbheag/splashscreens/" + currentSplashScreenFilename;
            document.getElementById('zoomdiv').style.display = 'block';

            window.onclick = function () {
                document.getElementById('zoomdiv').style.display = "none";
                window.onclick = null;
            };

        }

        ///// Audio Management Scripts //////////

        var music = document.getElementById('music');
        // synchronise currentTime with playhead position : it seems to
        // fire every second or so.
        music.addEventListener("timeupdate", timeUpdate);
        var pbutton = document.getElementById('pbutton');

        music.paused = true;

        function toggleAudio() {
            if (music.paused) {
                playAudio();
            } else {
                pauseAudio();
            }
        }

        function playAudio() {

            // if the Companion can't find a download file for an episode it will display an
            // error message via music.addEventListener and direct the user to the appropriate
            // download file. But if at this point they click the play button (even after the 
            // download is complete) Javascript throw a strange "Uncaught (in promise)
            // DOMException: The element has no supported sources." error. Resetting music.src
            // seems to clear this, but this also resets music.currentTime and since playAudio
            // is called in numerous places, this rather messes things up unles we /only/
            // reset music.src after we've had an error

            if (audioExceptionMessageJustDisplayed) {

                // clear the message in hopeful anticipation

                setActivityPanelToString("<p style = 'text-align: center'>Download now located - thanks</p>");
                audioExceptionMessageJustDisplayed = false;
                music.src = currentBBCDownloadFilename + ".mp3"

            }

            music.play();
            if (!audioExceptionMessageJustDisplayed)
                pbutton.style.backgroundImage = "url('https://ngatesystems.com/beagairbheag/img/pause.png')";
        }

        function pauseAudio() {
            music.pause();
            pbutton.style.backgroundImage = "url('https://ngatesystems.com/beagairbheag/img/play.png')";
        }

        var rewindTime;

        function rewindAudio() {

            rewindTime = Math.floor(music.currentTime); // Note positions are integers

            // stop music whether playing or not
            music.pause();
            //rewind 5 seconds then restart and pause at rewindTime
            music.currentTime = Math.max(0, (rewindTime - 5.0));
            music.ontimeupdate = function () {
                restrictMusic();
            };
            music.play();
        }


        function restrictMusic() {
            // Stop music playing when it reaches rewindTime
            if (music.currentTime > rewindTime) {
                pauseAudio();
                music.ontimeupdate = undefined;
                music.currentTime = rewindTime;
            }
        }

        var playhead = document.getElementById('playhead');
        var currtime = document.getElementById("currtime");

        // Synchronize playhead position with current point in audio
        function timeUpdate() {

            // We calculate the left margin of the playhead at time t seconds as :
            // (t * (playWidth  - headWidth)) / duration)

            playhead.style.marginLeft = (music.currentTime * (playWidth - headWidth)) / duration + "px";

            currtime.innerHTML = formatTime(music.currentTime);

            if (music.currentTime >= duration) {
                pbutton.style.backgroundImage = "url('https://ngatesystems.com/beagairbheag/img/play.png')";
                playhead.style.marginLeft = "0px";
                music.paused = true;
                currtime.innerHTML = "00:00:00";
            }

        }

        // make playline clickable
        playline.addEventListener("click", clickOnPlayline);

        var clickOnPlayhead = false;
        var musicInterruptedByMouseDown; //flag to show music was playing before mousedown event prior to moving playhead

        function clickOnPlayline(event) {
            // This function is intended to move the playhead to a new position. But if we mousedown 
            // on the playhead at the start of a drag we also get a a "click on playline" when we lift the mouse
            // at the end of the drag. So only respond to this click event if we /didn't/ mousedown on playhead

            if (!clickOnPlayhead) {

                // timeUpdate will move the playhead    
                music.currentTime = duration * clickPercent(event);
                playAudio();
            }
        }

        // make playline respond to mousewheel
        playline.addEventListener("wheel", wheelOnPlayline);

        function wheelOnPlayline(event) {
            // This function advances or rewinds the playhead by 2 sec in reponse to movements of the mouse wheel
            //("inwheel");
            // timeUpdate will move the playhead 
            //Math.sign doesn't work in IE so use straight code
            if (event.deltaY > 0) {
                music.currentTime -= 2;
            } else {
                music.currentTime += 2;
            }
        }

        // makes playhead draggable
        playhead.addEventListener('pointerdown', mouseDownOnPlayhead);
        playline.addEventListener('pointerup', mouseUpOnPlayhead);

        // mouseDown EventListener
        function mouseDownOnPlayhead() {
            //console.log("in mousedownonplayhead");
            clickOnPlayhead = true;
            // We use two techniques to move the playhead. Generally, the playhead is moved by the timeUpdate
            // function which moves the playhead by tracking music.currentTime. But during "dragging" of the
            // playhead (which is provided just as a more natural way of repositioning the playhead in a 
            // "closeup" situation) it seems best to pause the sound to avoid garbled noises. During this 
            // period we use "eventx" to pick up the physical position of the muse and actually turn off
            // timeUpdate to avoid confusion. It gets restarted by mouseUpOnPlayhead

            playline.addEventListener('pointermove', movePlayhead);
            music.removeEventListener("timeupdate", timeUpdate);

            musicInterruptedByMouseDown = false;
            // pause music while mousedown
            if (!music.paused) {
                musicInterruptedByMouseDown = true;
                pauseAudio();
            }
        }

        function mouseUpOnPlayhead(event) {

            // mouseUp is always on playhead, but this may be as a result of a click on playline rather
            // than a mousedown on playhead followed by a drag. Ignore the playline click

            if (clickOnPlayhead) {
                playline.removeEventListener('pointermove', movePlayhead);
                music.addEventListener("timeupdate", timeUpdate);
                clickOnPlayhead = false;

                music.currentTime = duration * clickPercent(event);
                //console.log("in mouseuponplayhead1 " + duration + " " + clickPercent(event));

                // restart music if it was playing before we moved the playhead - but in the new position. The
                // playhead position will be updated by timeUpdate
                if (musicInterruptedByMouseDown) {
                    playAudio();
                }
            }
        }

        // Move playhead as user drags
        function movePlayhead(event) {

            // move playhead using "Eventx" approach
            var newMargLeft = event.clientX - getPosition(playline) - 0.5 * playhead.offsetWidth;
            //console.log("In movePlayhead newMargLeft duration click%" + newMargLeft + " " + duration + " " + clickPercent(event));

            if (newMargLeft >= 0 && newMargLeft <= playWidth) {
                playhead.style.marginLeft = newMargLeft + "px";
            }
            if (newMargLeft < 0) {
                playhead.style.marginLeft = "0px";
                // regard the Playhead move as terminated if we go off the ends, otherwise we end up
                // find ourselves 'mouse-upping' off the playhead and so don't catch the event
                playline.removeEventListener('pointermove', movePlayhead);
                music.addEventListener("timeupdate", timeUpdate);
                music.currentTime = 0;
            }
            if (newMargLeft > (playWidth - headWidth)) {
                playhead.style.marginLeft = (playWidth - headWidth) + "px";
                playline.removeEventListener('pointermove', movePlayhead);
                music.addEventListener("timeupdate", timeUpdate);
                music.currentTime = duration;
            }

            document.getElementById("currtime").innerHTML = formatTime(Math.round(duration * clickPercent(event)));

            // recoverTextPanel();
        }

        // return click as decimal proportion of the playWidth
        function clickPercent(event) {
            var position = getPosition(playline);
            // clientx gives the pixel position of the click event relative to the left
            // of the viewport
            var returnval = (event.clientX - position - 0.5 * headWidth) / (playWidth - headWidth);
            if (returnval < 0) returnval = 0;
            return returnval;
        }


        // getPosition
        // Returns the pixel left position of the clecked element (inc padding and border)
        // relative to top-left of viewport
        function getPosition(el) {
            var returnval = el.getBoundingClientRect().left;
            return returnval;
        }

        var postTime;
        var biteStartTime;
        var biteFinishTime;

        //Play Soundbite
        function playBite() {
            // stop music (if playing), move playhead to biteStartime then start soundbite
            if (!music.paused) {
                // stop music
                musicInterrupted = true;
                music.currentTime = biteStartTime;
            }
            biteStartTime = postTime - 5.0;
            biteStartTime = Math.max(0, biteStartTime);
            biteFinishTime = postTime;
            music.currentTime = biteStartTime;
            music.ontimeupdate = function () {
                restrictSoundbite();
            };
            playAudio();
        }

        //Play soundbite nudged 1 second left
        function playBiteNudgedLeft() {
            postTime = postTime - 1.0;
            biteStartTime = postTime - 5.0;
            biteStartTime = Math.max(0, biteStartTime);
            biteFinishTime = postTime;
            music.currentTime = biteStartTime;
            music.ontimeupdate = function () {
                restrictSoundbite();
            };
            playAudio();


        }
        //Play soundbite nudged 1 second right
        function playBiteNudgedRight() {
            postTime = postTime + 1.0
            biteStartTime = postTime - 5.0;
            biteStartTime = Math.max(0, biteStartTime);
            biteFinishTime = postTime;
            music.currentTime = biteStartTime
            music.ontimeupdate = function () {
                restrictSoundbite();
            };
            playAudio();

        }

        //Play Soundbite in Edit Panel
        function playBiteInEditPanel() {

            if (!music.paused) {
                // stop music
                music.pause();
            }
            music.currentTime = postTime;
            document.getElementById("currtime").innerHTML = formatTime(Math.round(postTime));
            biteStartTime = postTime - 5.0;
            biteStartTime = Math.max(0, biteStartTime);
            biteFinishTime = postTime;
            music.currentTime = biteStartTime;
            music.ontimeupdate = function () {
                restrictSoundbite();
            };
            playAudio();

        }

        function restrictSoundbite() {
            // Stop the soundbite when it reaches biteFinishTime and reset music.CurrentTime to postTime
            if (music.currentTime > biteFinishTime) {
                music.ontimeupdate = undefined;
                pauseAudio();
                music.currentTime = postTime;
                document.getElementById("currtime").innerHTML = formatTime(Math.round(postTime));
            }
        }
        function timeToSeconds(time) {

            // convert a database coded "time" field (mmss) to seconds

            var timeSeconds = time % 100;
            var timeMinutes = (time - timeSeconds) / 100;
            return timeMinutes * 60 + timeSeconds;
        }

        // Formats currentTime in ssssss.ssss as hh:mm:ss : rounds to nearest integer
        function formatTime(t) {
            t = Math.round(t);
            var s = t % 60;
            var m = Math.floor(t / 60) % 60;
            var h = Math.floor(t / 3600);
            var tFormatted = normaliseTime(h) + ":" + normaliseTime(m) + ":" + normaliseTime(s);
            return tFormatted;
        }

        // add a leading zero to a time field if necessary
        function normaliseTime(t) {
            var nt = t.toString();
            if (t < 10) {
                nt = "0" + t;
            }
            return nt;
        }

        ///// Demo Stuff //////////

    </script>

    <div id="demobanner" style="position: absolute; top: 0px; left: 0px; display: block; width: 100%; height: 100%;">
        <img style="height: 100%; width: 100%;" src="https:ngatesystems.com/beagairbheag/demo/demobanner.jpg"
            onclick="document.getElementById('demobanner').style.display = 'none'; playDemoPhase1();">
    </div>

    <script>

        async function playDemoPhase1() {

            // show the companion for 2 sec
            await wait(function () { }, 2);

            // take over the activity panel 
            var printString = "\
            Welcome to 'The BaB Companion'!.<br><br> You're looking at the Companion\
            running in Google Chrome. The rinky-dink 'tickertape' arrangement delivering this commentary is just something\
            I cooked up to counter the fact\
            that I'm better at typing than talking! It has temporarily appropriated the 'activity panel'\
            where most of the Companion's interaction takes place. <br><br>\
            As you can see, the Companion's main feature is the central grey bar\
            of its 'audio line'. The round, black 'playhead' indicates the current audio position.<br><br>\
            The Companion is currently focussed on Episode 1\
            of BaB Series 12. Let's click the 'play' button in the control panel\
            immediately above the audio line and start playback of this episode.";
            for (var i = 0; i <= printString.length; i++) {
                await typeComment(printString, i);
            }

            // set a click on the logo to start the second bit of the demo when you've finished demonstrating the
            // playline

            logo.setAttribute("onclick", "playDemoPhase1a();");

        }

        async function playDemoPhase1a() {

            var printString = "\
            We can move the 'playhead' to a new position in a variety of different ways - by clicking on the playline, \
            dragging the playhead or pointing to it and twiddling the mouse scroll wheel.";
            for (var i = 0; i <= printString.length; i++) {
                await typeComment(printString, i);
            }

            // set a click on the logo to start the second bit of the demo when you've finished demonstrating the
            // playline

            logo.setAttribute("onclick", "playDemoPhase2();");

        }

        async function playDemoPhase2() {

            var printString = "\
            When you hit a section of the audio that you can't quite follow, you'll probably want to replay it\
            repeatedly while you work out what is going on.<br><br>\
            You <b>could</b> do this by scrolling back on the playhead but it's easier to use the special tool\
            that the Companion provides precisely for this purpose.<br><br>\
            Click the ? button on the audio control panel and you'll find that the audio replays the last\
            5 seconds and then stops to give you time to think. Click again and the process is repeated.";

            for (var i = 0; i <= printString.length; i++) {
                await typeComment(printString, i);
            }


            // set a click on the logo to start the third bit of the demo when you've finished demonstrating the
            //? button

            logo.setAttribute("onclick", "playDemoPhase3();");

        }

        async function playDemoPhase3() {

            var printString = "\
            When you do, finally, work out what's going on, you may want to make a note to remind yourself of your\
            insight next time you play this episode. Cick the ! button on\
            the audio control panel and you'll see a 'note-entry' form appear in the central activity panel. Use\
            the 'nudge' controls to position the 5-second 'sound-bite' that will accompany the note and enter some\
            interpretative details. <br><br>\
            When you finally 'save' the note you'll find that a black ! character appears  above the audio line\
            at the note's position. Your note is now stored permanently in browser storage and its ! indicator will\
            be re-displayed whenever you revisit this episode. If you click on it you'll hear the\
            note's sound-bite and see your note-text again in the activity panel.";

            for (var i = 0; i <= printString.length; i++) {
                await typeComment(printString, i);
            }

            // reset the click on the logo so you can demnstrate the query facility

            logo.setAttribute("onclick", "playDemoPhase4();");
        }

        async function playDemoPhase4() {

            var printString = "\
            If you are temporarily defeated by a bit of audio, you may find it useful to save a note that\
            shows that the section is problematic and which stands out in some way from\
            note-marks that are just there as reminders. <br><br>\
            The Companion enables you to do this by providing a facility to save notes on problem sections as 'queries'\
            rather than 'notes'. Queries are indicated on the noteline as red ? characters rather than black ! marks. <br><br>\
            When you do finally sort the problem out - the penny usually drops eventually - you can update\
            the text and resave it as a note, thus changing its indicator back to a ! mark.";

            for (var i = 0; i <= printString.length; i++) {
                await typeComment(printString, i);
            }

            // reset the click on the logo so you can demonstrate the text facility

            var onclickLink = "playDemoPhase5();";
            logo.setAttribute("onclick", onclickLink);
        }

        async function playDemoPhase5() {

            var printString = "\
            The coloured blocks below the play-line indicate the location of the transcripts that accompany\
            every BaB episode. Tooltips will appear when you mouse-over the blocks to tell you what they contain. Clicking\
            on a block will cause its content to be displayed in the activity panel. Clicking on a word in the\
            transcript will fire up the currently-selected dictionary to provide a  definition.";

            for (var i = 0; i <= printString.length; i++) {
                await typeComment(printString, i);
            }

            // reset the click on the logo so you can demonstrate the dictionary facility

            var onclickLink = "playDemoPhase6();";
            logo.setAttribute("onclick", onclickLink);
        }

        async function playDemoPhase6() {

            var printString = "\
            There are plenty more tricks up the Companion's sleeve, but you've probably had enough for now. <br><br>\
            For more information check out the 'readme' file on the Companion's github repository page\
            at https://github.com/mjoycemilburn/beagairbheag. <br><br>Enjoy!";

            for (var i = 0; i <= printString.length; i++) {
                await typeComment(printString, i);
            }

        }

        function wait(myFunction, waitSeconds) {
            return new Promise(function (resolve, reject) {
                setTimeout(function () {
                    myFunction();
                    resolve();
                }, waitSeconds * 1000);

            });
        }

        function typeComment(textString, n) {
            // set innerHTML of element "test" to the first n chars of textString]
            return new Promise(function (resolve, reject) {
                setTimeout(function () {
                    activitypanel.innerHTML = textString.substring(0, n);
                    resolve();
                }, 20);
            });
        }

    </script>








    </script>
</body>

</html>